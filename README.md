# Principle of Least Privilege Orchestration Script
Linkedin: https://www.linkedin.com/in/mr-lopeza/

This project provides scripts to automate the setup and verification of least privilege permissions for a dedicated log reading user on a Linux system using Access Control Lists (ACLs).

## 1. Scenario

The goal is to create a dedicated user account, `log-reader`, with the sole permission to read log files ending in `.log` located within the `/var/log/webapp/` directory.

This user **must** have:
* Read access to files matching `/var/log/webapp/*.log`.
* Ability to navigate into the `/var/log/webapp/` directory.

This user **must NOT** have:
* Permission to read files outside `/var/log/webapp/` (unless granted by default system permissions).
* Permission to modify, delete, or create files within `/var/log/webapp/`.
* Permission to execute commands beyond basic shell utilities required for navigation and reading.

## 2. Least Privilege Design

To achieve the required granularity and handle newly created log files automatically, **Linux Access Control Lists (ACLs)** were chosen as the primary mechanism.

The design involves:
* **User Creation:** Creating a system user `log-reader` (if it doesn't exist) with a restricted or standard shell.
* **Directory Permissions:**
    * Granting the `log-reader` user `read` (r) and `execute` (x) permissions on the `/var/log/webapp/` directory itself. This allows the user to `cd` into the directory and list its contents.
* **File Permissions (Existing):**
    * Granting the `log-reader` user `read` (r) permission on any existing files matching `*.log` within `/var/log/webapp/`.
* **Default ACLs (for New Files/Dirs):**
    * Setting a *default* ACL on `/var/log/webapp/` to automatically grant `read` (r) permission to `log-reader` for any *new files* created within the directory.
    * Setting a *default* ACL on `/var/log/webapp/` to automatically grant `read` (r) and `execute` (x) permission to `log-reader` for any *new subdirectories* created within the directory (ensures navigation if subdirs are used for logs).

This approach ensures that the `log-reader` user only gets the necessary permissions, and these permissions are maintained even when new log files are generated by the web application.

## 3. Scripts

Two scripts are provided:

* **`setup_logreader.sh`**:
    * Performs pre-flight checks (root access, ACL tools installed, filesystem ACL support).
    * Creates the `/var/log/webapp/` directory if it doesn't exist.
    * Creates the `log-reader` system user if it doesn't exist.
    * Applies the effective and default ACLs to the directory and existing log files as per the design.
    * The script is designed to be idempotent (safe to run multiple times).
* **`verify_logreader.sh`**:
    * Checks for the existence of the user and directory.
    * Uses `getfacl` to verify that the correct effective and default ACLs are set on the directory and sample log files.
    * Uses `sudo -u log-reader` to test specific actions:
        * Confirms *allowed* actions (e.g., `ls /var/log/webapp`, `cat /var/log/webapp/some.log`).
        * Confirms *denied* actions (e.g., `touch /var/log/webapp/test`, `cat /etc/shadow`, `rm /var/log/webapp/some.log`).
    * Tests default ACL inheritance by creating a temporary file (as root) and verifying the `log-reader` can read it.

## 4. Prerequisites

* **Root Access:** Both scripts must be run using `sudo` or as the root user.
* **ACL Support:** The filesystem containing `/var/log/webapp/` must be mounted with ACL support.
    * Check current mount options: `mount | grep ' / '` (replace `/` with the correct mount point if `/var/log` is separate). Look for the `acl` option.
    * If missing, add `acl` to the options in `/etc/fstab` for the relevant filesystem and remount (`sudo mount -o remount /path/to/mountpoint`) or reboot. For ext3/4, you might use `sudo tune2fs -o acl /dev/your_device`.
* **ACL Tools:** The `acl` package must be installed.
    * Debian/Ubuntu: `sudo apt update && sudo apt install acl`
    * CentOS/RHEL/Fedora: `sudo yum install acl` or `sudo dnf install acl`

## 5. Execution

1.  Save the setup script as `setup_logreader.sh`.
2.  Save the verification script as `verify_logreader.sh`.
3.  Make both scripts executable: `chmod +x setup_logreader.sh verify_logreader.sh`.
4.  Run the setup script: `sudo ./setup_logreader.sh`
5.  Review the setup script output for any errors or warnings.
6.  Run the verification script: `sudo ./verify_logreader.sh`

## 6. Verification

Review the output of the `verify_logreader.sh` script carefully.

* **Look for `[ OK ]` messages:** These indicate successful checks. Key checks include:
    * User and directory existence.
    * Correct ACL entries (effective and default) reported by `getfacl`.
    * Successful execution of *allowed* commands (like `ls`, `cat` on log files) when run as `log-reader`.
    * *Expected failure* (Permission Denied) of *denied* commands (like `touch`, `rm`, `cat /etc/shadow`) when run as `log-reader`.
* **Look for `[FAIL]` messages:** These indicate a problem with the setup or verification logic. The message will describe the failed check (e.g., incorrect ACL permissions found, a denied action succeeded unexpectedly, an allowed action failed).
* **Look for `[WARN]` messages:** These indicate non-critical issues or situations where a test couldn't be fully performed (e.g., no initial log files found to check specific file ACLs).

If all checks pass with `[ OK ]` (including expected failures for denied actions), the least privilege setup is verified.
